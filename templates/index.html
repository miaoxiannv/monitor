<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿œç¨‹è¿›ç¨‹ç›‘æ§ç®¡ç†</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { color: #333; margin-bottom: 10px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .monitor-card { border-left: 4px solid #2196F3; }
        .monitor-card.offline { border-left-color: #f44336; }
        .monitor-card.disabled { border-left-color: #9e9e9e; opacity: 0.7; }
        .monitor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .monitor-title { font-size: 18px; font-weight: bold; color: #333; }
        .monitor-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .info-item { font-size: 14px; color: #666; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-online { background: #4caf50; color: white; }
        .badge-offline { background: #f44336; color: white; }
        .badge-disabled { background: #9e9e9e; color: white; }
        .process-list { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .process-item { padding: 8px 12px; border-radius: 6px; font-size: 14px; }
        .process-running { background: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .process-stopped { background: #ffebee; color: #c62828; border: 1px solid #f44336; }
        .process-unknown { background: #f5f5f5; color: #666; border: 1px solid #ddd; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-primary:hover { background: #1976D2; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #388e3c; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-secondary { background: #757575; color: white; }
        .btn-secondary:hover { background: #616161; }
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .alert { padding: 12px 16px; border-radius: 4px; margin-bottom: 15px; display: none; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; border-radius: 8px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 20px; font-weight: bold; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { min-height: 80px; resize: vertical; font-family: monospace; }
        .help-text { font-size: 12px; color: #999; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–¥ï¸ è¿œç¨‹è¿›ç¨‹ç›‘æ§ç®¡ç†</h1>
            <p style="color: #777; margin-top: 10px;">ç›‘æ§å¤šå°Windows/Linuxæœºå™¨çš„è¿›ç¨‹çŠ¶æ€</p>
        </div>

        <div id="alertBox" class="alert"></div>

        <div class="card">
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showAddModal()">â• æ·»åŠ ç›‘æ§ç›®æ ‡</button>
                <button class="btn btn-success" onclick="testNotification()">ğŸ“± æµ‹è¯•é’‰é’‰é€šçŸ¥</button>
                <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>
        </div>

        <div id="monitorsList"></div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç›‘æ§ç›®æ ‡æ¨¡æ€æ¡† -->
    <div id="monitorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ·»åŠ ç›‘æ§ç›®æ ‡</div>
            <form id="monitorForm">
                <div class="form-group">
                    <label>åç§° *</label>
                    <input type="text" id="monitorName" required placeholder="ä¾‹å¦‚: ç”Ÿäº§æœåŠ¡å™¨">
                </div>
                <div class="form-group">
                    <label>ä¸»æœºåœ°å€ *</label>
                    <input type="text" id="monitorHost" required placeholder="ä¾‹å¦‚: 192.168.1.100">
                    <div class="help-text">è¢«ç›‘æ§æœºå™¨çš„IPåœ°å€æˆ–åŸŸå</div>
                </div>
                <div class="form-group">
                    <label>ç«¯å£ *</label>
                    <input type="number" id="monitorPort" value="8888" required>
                    <div class="help-text">AgentæœåŠ¡ç›‘å¬çš„ç«¯å£</div>
                </div>
                <div class="form-group">
                    <label>ç›‘æ§çš„è¿›ç¨‹ *</label>
                    <textarea id="monitorProcesses" required placeholder="æ¯è¡Œä¸€ä¸ªè¿›ç¨‹åï¼Œä¾‹å¦‚:&#10;nginx&#10;mysql&#10;redis-server"></textarea>
                    <div class="help-text">æ¯è¡Œè¾“å…¥ä¸€ä¸ªè¿›ç¨‹å</div>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <input type="text" id="monitorDesc" placeholder="é€‰å¡«: ç”Ÿäº§ç¯å¢ƒWebæœåŠ¡å™¨">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-success" onclick="testAgentConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
                    <button type="submit" class="btn btn-primary">ğŸ’¾ ä¿å­˜</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let editIndex = -1;

        // åŠ è½½ç›‘æ§ç›®æ ‡åˆ—è¡¨
        async function loadMonitors() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                renderMonitors(data.monitors || []);
            } catch (error) {
                showAlert('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ¸²æŸ“ç›‘æ§ç›®æ ‡
        function renderMonitors(monitors) {
            const container = document.getElementById('monitorsList');
            if (monitors.length === 0) {
                container.innerHTML = '<div class="card"><p style="text-align:center;color:#999;">æš‚æ— ç›‘æ§ç›®æ ‡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
                return;
            }

            container.innerHTML = monitors.map((m, index) => {
                const statusClass = !m.enabled ? 'disabled' : (m.agent_status === 'åœ¨çº¿' ? '' : 'offline');
                const statusBadge = !m.enabled ? 'badge-disabled' : (m.agent_status === 'åœ¨çº¿' ? 'badge-online' : 'badge-offline');

                return `
                    <div class="card monitor-card ${statusClass}">
                        <div class="monitor-header">
                            <div>
                                <span class="monitor-title">${m.monitor_name}</span>
                                <span class="badge ${statusBadge}">${m.agent_status}</span>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-secondary" onclick="editMonitor(${index})">âœï¸ ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="deleteMonitor(${index}, '${m.monitor_name}')">ğŸ—‘ï¸ åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="monitor-info">
                            <div class="info-item">ğŸ–¥ï¸ ä¸»æœº: ${m.host}:${m.port}</div>
                            <div class="info-item">ğŸ”§ Agent: ${m.agent_hostname}</div>
                            <div class="info-item">ğŸ“ ${m.description || 'æ— æè¿°'}</div>
                        </div>
                        <div class="process-list">
                            ${m.processes.map(p => {
                                const statusClass = p.running === null ? 'process-unknown' : (p.running ? 'process-running' : 'process-stopped');
                                const icon = p.running === null ? 'â“' : (p.running ? 'âœ…' : 'âŒ');
                                return `<div class="process-item ${statusClass}">${icon} ${p.name}</div>`;
                            }).join('')}
                        </div>
                        ${m.processes.filter(p => p.last_alert !== 'ä»æœªå‘Šè­¦').length > 0 ? `
                            <div style="font-size:12px;color:#999;margin-top:10px;">
                                æœ€è¿‘å‘Šè­¦: ${m.processes.filter(p => p.last_alert !== 'ä»æœªå‘Šè­¦').map(p => `${p.name} (${p.last_alert})`).join(', ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            editIndex = -1;
            document.getElementById('monitorForm').reset();
            document.querySelector('.modal-header').textContent = 'æ·»åŠ ç›‘æ§ç›®æ ‡';
            document.getElementById('monitorModal').style.display = 'flex';
        }

        // ç¼–è¾‘ç›‘æ§ç›®æ ‡
        async function editMonitor(index) {
            editIndex = index;
            const res = await fetch('/api/monitors');
            const data = await res.json();
            const monitor = data.monitors[index];

            document.getElementById('monitorName').value = monitor.name;
            document.getElementById('monitorHost').value = monitor.host;
            document.getElementById('monitorPort').value = monitor.port;
            document.getElementById('monitorProcesses').value = monitor.processes.join('\n');
            document.getElementById('monitorDesc').value = monitor.description || '';

            document.querySelector('.modal-header').textContent = 'ç¼–è¾‘ç›‘æ§ç›®æ ‡';
            document.getElementById('monitorModal').style.display = 'flex';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('monitorModal').style.display = 'none';
        }

        // ä¿å­˜ç›‘æ§ç›®æ ‡
        document.getElementById('monitorForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const monitor = {
                name: document.getElementById('monitorName').value.trim(),
                host: document.getElementById('monitorHost').value.trim(),
                port: parseInt(document.getElementById('monitorPort').value),
                processes: document.getElementById('monitorProcesses').value.split('\n').map(s => s.trim()).filter(s => s),
                description: document.getElementById('monitorDesc').value.trim(),
                enabled: true
            };

            try {
                const url = editIndex >= 0 ? `/api/monitors/${editIndex}` : '/api/monitors';
                const method = editIndex >= 0 ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(monitor)
                });

                const data = await res.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    closeModal();
                    loadMonitors();
                } else {
                    showAlert('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        });

        // åˆ é™¤ç›‘æ§ç›®æ ‡
        async function deleteMonitor(index, name) {
            if (!confirm(`ç¡®è®¤åˆ é™¤ç›‘æ§ç›®æ ‡ "${name}"ï¼Ÿ`)) return;

            try {
                const res = await fetch(`/api/monitors/${index}`, {method: 'DELETE'});
                const data = await res.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    loadMonitors();
                } else {
                    showAlert('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•Agentè¿æ¥
        async function testAgentConnection() {
            const host = document.getElementById('monitorHost').value.trim();
            const port = parseInt(document.getElementById('monitorPort').value);

            if (!host) {
                showAlert('è¯·è¾“å…¥ä¸»æœºåœ°å€', 'error');
                return;
            }

            showAlert('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'success');

            try {
                const res = await fetch('/api/test-agent', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({host, port})
                });

                const data = await res.json();

                if (data.success) {
                    showAlert(`âœ… è¿æ¥æˆåŠŸï¼Agentä¸»æœº: ${data.data.hostname}`, 'success');
                } else {
                    showAlert('âŒ ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•é’‰é’‰é€šçŸ¥
        async function testNotification() {
            showAlert('æ­£åœ¨å‘é€æµ‹è¯•æ¶ˆæ¯...', 'success');

            try {
                const res = await fetch('/api/test-notification', {method: 'POST'});
                const data = await res.json();

                if (data.success) {
                    showAlert('âœ… æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼Œè¯·æ£€æŸ¥é’‰é’‰ç¾¤', 'success');
                } else {
                    showAlert('âŒ å‘é€å¤±è´¥: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('âŒ å‘é€å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = message;
            alertBox.className = 'alert alert-' + type;
            alertBox.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 3000);
            }
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('monitorModal').addEventListener('click', (e) => {
            if (e.target.id === 'monitorModal') closeModal();
        });

        // åˆå§‹åŠ è½½
        loadMonitors();

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
        setInterval(loadMonitors, 30000);
    </script>
</body>
</html>
